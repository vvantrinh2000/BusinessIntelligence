<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Habit Tracker</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --muted:#334155;     /* slate-700 */
      --text:#e5e7eb;      /* gray-200 */
      --sub:#94a3b8;       /* slate-400 */
      --accent:#22d3ee;    /* cyan-400 */
      --accent-2:#a78bfa;  /* violet-400 */
      --good:#34d399;      /* emerald-400 */
      --bad:#f87171;       /* red-400 */
      --card:#0b1222;      /* custom */
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 600px at 10% -20%,rgba(167,139,250,.15),transparent),
                 radial-gradient(900px 500px at 120% 20%,rgba(34,211,238,.12),transparent),
                 var(--bg);
      color:var(--text);
    }
    .app{
      display:grid; grid-template-columns: 320px 1fr; gap:18px; padding:22px; max-width:1400px; margin:0 auto;
    }
    @media (max-width: 900px){.app{grid-template-columns: 1fr}}

    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    /* Sidebar */
    .sidebar{padding:18px}
    .header{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2)); box-shadow:0 8px 20px rgba(167,139,250,.25)}
    h1{font-size:1.2rem;margin:0}
    .sub{color:var(--sub); font-size:.9rem}

    .add-row{display:flex;gap:8px;margin-top:12px}
    .add-row input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(2,6,23,.6);color:var(--text)}
    .btn{
      padding:10px 12px; border:none; border-radius:12px; cursor:pointer; color:#0b1020; font-weight:600;
      background:linear-gradient(180deg,var(--accent),#14b8a6); box-shadow:0 6px 16px rgba(20,184,166,.35);
    }
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.12)}

    .habits{margin-top:14px; display:flex; flex-direction:column; gap:10px; max-height:45vh; overflow:auto; padding-right:6px}
    .habit{
      display:flex; gap:10px; align-items:center; justify-content:space-between; background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06); padding:10px; border-radius:14px
    }
    .habit-left{display:flex;align-items:center;gap:10px}
    .dot{width:14px;height:14px;border-radius:50%; box-shadow:0 0 0 3px rgba(255,255,255,.06) inset}
    .habit .name{font-weight:600}
    .muted{color:var(--sub); font-size:.85rem}
    .habit .actions{display:flex; gap:6px}
    .icon-btn{background:transparent;border:1px solid rgba(255,255,255,.12); color:var(--text); border-radius:10px; padding:6px 8px; cursor:pointer}

    .tools{margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:8px}

    /* Main */
    .main{padding:18px; display:flex; flex-direction:column; gap:14px}
    .cal-head{display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:8px}
    .nav{display:flex; gap:8px}
    .nav button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(2,6,23,.6);color:var(--text);cursor:pointer}
    .month-title{font-size:1.1rem; font-weight:700}

    .calendar{width:100%; border-collapse:separate; border-spacing:6px}
    .calendar th{color:var(--sub); font-weight:600; text-align:center}
    .calendar td{
      background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:12px; vertical-align:top; width:14.28%; height:110px; position:relative; overflow:hidden
    }
    .date-badge{position:absolute; top:6px; left:6px; font-size:.8rem; color:var(--sub)}
    .cells{display:flex; flex-direction:column; gap:6px; padding:26px 8px 8px; max-height:100%; overflow:auto}
    .pill{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:10px; cursor:pointer; border:1px solid rgba(255,255,255,.08); background:rgba(2,6,23,.5); font-size:.9rem}
    .pill.done{outline:2px solid rgba(52,211,153,.45); background:rgba(16,185,129,.12)}
    .pill .p-dot{width:10px;height:10px;border-radius:50%}
    .empty{color:var(--sub); font-size:.9rem; text-align:center; padding-top:36px}

    .legend{display:flex; gap:10px; flex-wrap:wrap}
    .legend .item{display:flex; align-items:center; gap:8px}
    .legend .swatch{width:14px;height:14px;border-radius:50%}

    .footer{display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:10px; color:var(--sub)}
    .linklike{cursor:pointer; text-decoration:underline}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar panel" aria-label="Habit controls">
      <div class="header">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Habit Tracker</h1>
          <div class="sub">Runs fully offline • Saves to your browser</div>
        </div>
      </div>

      <div class="add-row" aria-label="Add a new habit">
        <input id="habitName" placeholder="Add a habit (e.g., Read 10 pages)" aria-label="Habit name" />
        <button class="btn" id="addHabitBtn" title="Add habit">Add</button>
      </div>

      <div class="habits" id="habitList" aria-live="polite"></div>

      <div class="tools">
        <button class="btn secondary" id="exportBtn" title="Export data to file">Export</button>
        <label class="btn secondary" for="importFile" title="Import data from file" style="text-align:center; cursor:pointer">Import</label>
        <input id="importFile" type="file" accept="application/json" class="sr-only" />
        <button class="btn secondary" id="resetBtn" title="Clear all data">Reset</button>
        <button class="btn secondary" id="todayBtn" title="Jump to today">Today</button>
      </div>

      <p class="muted" style="margin-top:10px">Tip: Click a habit name to edit. Click on calendar cells to toggle completion.</p>
    </aside>

    <!-- Main -->
    <main class="main panel">
      <div class="cal-head">
        <div class="month-title" id="monthTitle" aria-live="polite"></div>
        <div class="nav" role="group" aria-label="Month navigation">
          <button id="prevBtn" aria-label="Previous month">◀</button>
          <button id="nextBtn" aria-label="Next month">▶</button>
        </div>
      </div>

      <div class="legend" id="legend"></div>

      <table class="calendar" aria-label="Monthly calendar">
        <thead>
          <tr id="weekdayRow"></tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>

      <div class="footer">
        <div id="stats"></div>
        <div class="muted">Data lives in <strong>localStorage</strong> and never leaves your device.</div>
      </div>
    </main>
  </div>

  <script>
    // ---------- Storage ----------
    const STORAGE_KEY = 'habit-tracker-v1';
    const COLORS = ['#22d3ee','#a78bfa','#34d399','#fbbf24','#f43f5e','#60a5fa','#f59e0b','#10b981'];

    const state = load() || {
      habits: [
        { id: id(), name: 'Drink water', color: COLORS[0] },
        { id: id(), name: 'Walk 20 min', color: COLORS[2] }
      ],
      logs: {}, // { 'YYYY-MM-DD': { habitId: true } }
      view: null
    };

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch{ return null } }
    function id(){ return Math.random().toString(36).slice(2,9); }

    // ---------- Dates ----------
    const WEEK_START = 1; // 0=Sunday, 1=Monday

    function fmtDate(d){ return d.toISOString().slice(0,10); }
    function parseDate(str){ const [y,m,day] = str.split('-').map(Number); return new Date(y, m-1, day); }

    function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
    function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }

    function getCalendarMatrix(date){
      const first = startOfMonth(date);
      const last = endOfMonth(date);
      const daysInMonth = last.getDate();
      const offset = mod(first.getDay() - WEEK_START, 7);
      const totalCells = Math.ceil((offset + daysInMonth) / 7) * 7;
      const cells = [];
      for (let i=0; i<totalCells; i++){
        const dayNum = i - offset + 1;
        if (dayNum < 1 || dayNum > daysInMonth){ cells.push(null); }
        else{ cells.push(new Date(date.getFullYear(), date.getMonth(), dayNum)); }
      }
      return chunk(cells,7);
    }

    function mod(n,m){ return ((n % m) + m) % m; }
    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }

    // ---------- Rendering ----------
    const monthTitle = document.getElementById('monthTitle');
    const calendarBody = document.getElementById('calendarBody');
    const weekdayRow = document.getElementById('weekdayRow');
    const legend = document.getElementById('legend');
    const stats = document.getElementById('stats');
    const habitList = document.getElementById('habitList');

    const weekdays = (()=>{
      const names = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      return names.slice(WEEK_START).concat(names.slice(0,WEEK_START));
    })();

    function renderWeekdays(){
      weekdayRow.innerHTML = weekdays.map(d=>`<th scope="col">${d}</th>`).join('');
    }

    let current = (()=>{
      const today = new Date(); today.setHours(0,0,0,0);
      return new Date(today.getFullYear(), today.getMonth(), 1);
    })();

    function render(){
      renderWeekdays();
      renderLegend();
      renderSidebar();
      renderCalendar();
      renderStats();
      save();
    }

    function renderLegend(){
      if (!state.habits.length){ legend.innerHTML = '<span class="muted">Add habits to get started.</span>'; return; }
      legend.innerHTML = state.habits.map(h=>`<div class="item"><span class="swatch" style="background:${h.color}"></span><span>${escapeHtml(h.name)}</span></div>`).join('');
    }

    function renderSidebar(){
      habitList.innerHTML = state.habits.map(h=>{
        const streak = calcStreak(h.id);
        return `<div class="habit" data-id="${h.id}">
          <div class="habit-left">
            <div class="dot" style="background:${h.color}"></div>
            <button class="icon-btn rename" title="Rename habit">✏️</button>
            <span class="name">${escapeHtml(h.name)}</span>
          </div>
          <div class="actions">
            <span class="muted">🔥 ${streak}d</span>
            <button class="icon-btn color" title="Change color">🎨</button>
            <button class="icon-btn delete" title="Delete habit">🗑️</button>
          </div>
        </div>`
      }).join('');
    }

    function renderCalendar(){
      const matrix = getCalendarMatrix(current);
      monthTitle.textContent = current.toLocaleDateString(undefined, { month:'long', year:'numeric' });
      calendarBody.innerHTML = matrix.map(week=>{
        return `<tr>` + week.map(day=>{
          if (!day) return `<td aria-disabled="true"></td>`;
          const dateKey = fmtDate(day);
          const entries = state.logs[dateKey] || {};
          const pills = state.habits.map(h=>{
            const done = !!entries[h.id];
            return `<div class="pill ${done?'done':''}" data-date="${dateKey}" data-habit="${h.id}" role="button" aria-pressed="${done}">
              <span class="p-dot" style="background:${h.color}"></span>
              <span>${escapeHtml(h.name)}</span>
            </div>`
          }).join('');
          return `<td>
              <div class="date-badge">${day.getDate()}</div>
              <div class="cells">${pills || '<div class="empty">—</div>'}</div>
            </td>`;
        }).join('') + `</tr>`;
      }).join('');
    }

    function renderStats(){
      const monthDays = daysInMonth(current);
      const todayStr = fmtDate(new Date());
      const totals = state.habits.map(h=>{
        let done=0; for(const d of monthDays){ if(state.logs[d]?.[h.id]) done++; }
        return { id:h.id, name:h.name, percent: monthDays.length? Math.round(done*100/monthDays.length):0 };
      });
      const todayCount = Object.keys(state.logs[todayStr]||{}).length;
      stats.innerHTML = `<span class="muted">Today: ${todayCount}/${state.habits.length} done</span> • `+
        totals.map(t=>`${escapeHtml(t.name)}: ${t.percent}%`).join(' • ');
    }

    function daysInMonth(date){
      const arr=[]; const first = startOfMonth(date); const last = endOfMonth(date);
      for(let d=new Date(first); d<=last; d.setDate(d.getDate()+1)) arr.push(fmtDate(d));
      return arr;
    }

    function calcStreak(habitId){
      // Count consecutive days backwards from today
      let d = new Date(); d.setHours(0,0,0,0);
      let streak = 0;
      while(true){
        const key = fmtDate(d);
        if (state.logs[key]?.[habitId]){ streak++; d.setDate(d.getDate()-1); }
        else break;
      }
      return streak;
    }

    // ---------- Events ----------
    document.getElementById('addHabitBtn').addEventListener('click', ()=>{
      const input = document.getElementById('habitName');
      const name = input.value.trim();
      if(!name) return;
      const color = COLORS[(state.habits.length) % COLORS.length];
      state.habits.push({ id:id(), name, color });
      input.value='';
      render();
    });

    document.getElementById('habitName').addEventListener('keydown', e=>{
      if(e.key==='Enter') document.getElementById('addHabitBtn').click();
    });

    habitList.addEventListener('click', (e)=>{
      const wrap = e.target.closest('.habit'); if(!wrap) return;
      const idAttr = wrap.getAttribute('data-id');
      const h = state.habits.find(x=>x.id===idAttr);
      if(!h) return;
      if(e.target.classList.contains('delete')){
        if(confirm('Delete this habit?')){
          state.habits = state.habits.filter(x=>x.id!==h.id);
          // remove logs for this habit
          for(const date in state.logs){ if(state.logs[date][h.id]) delete state.logs[date][h.id]; }
          render();
        }
      } else if(e.target.classList.contains('color')){
        const idx = COLORS.indexOf(h.color);
        h.color = COLORS[(idx+1)%COLORS.length];
        render();
      } else if(e.target.classList.contains('rename') || e.target.classList.contains('name')){
        const newName = prompt('Rename habit:', h.name);
        if(newName && newName.trim()){
          h.name = newName.trim();
          render();
        }
      }
    });

    calendarBody.addEventListener('click', (e)=>{
      const pill = e.target.closest('.pill'); if(!pill) return;
      const date = pill.getAttribute('data-date');
      const habitId = pill.getAttribute('data-habit');
      const day = state.logs[date] || (state.logs[date] = {});
      day[habitId] = !day[habitId];
      if(!day[habitId]) delete day[habitId];
      if(Object.keys(day).length===0) delete state.logs[date];
      renderCalendar();
      renderStats();
      save();
    });

    // Month navigation
    document.getElementById('prevBtn').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()-1, 1); render(); });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ current = new Date(current.getFullYear(), current.getMonth()+1, 1); render(); });
    document.getElementById('todayBtn').addEventListener('click', ()=>{ const t=new Date(); current = new Date(t.getFullYear(), t.getMonth(), 1); render(); });

    // Export / Import / Reset
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'habit-tracker-data.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if(!data || !Array.isArray(data.habits) || typeof data.logs !== 'object') throw new Error('Invalid file');
          state.habits = data.habits; state.logs = data.logs || {}; save(); render();
        } catch(err){ alert('Import failed: ' + err.message); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(confirm('This clears all habits and history. Continue?')){
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    });

    // Utilities
    function escapeHtml(str){
      return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[s]));
    }

    // Init
    render();
  </script>
</body>
</html>
